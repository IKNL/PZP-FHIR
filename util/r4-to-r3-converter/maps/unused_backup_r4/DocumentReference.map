map "http://hl7.org/fhir/StructureMap/DocumentReference4to3" = "R4 to R3 Conversion for DocumentReference"

uses "http://hl7.org/fhir/StructureDefinition/DocumentReference" alias DocumentReference as source
uses "http://hl7.org/fhir/3.0/StructureDefinition/DocumentReference" alias DocumentReferenceR3 as target

imports "http://hl7.org/fhir/StructureMap/*4to3"

group DocumentReference(source src : DocumentReference, target tgt : DocumentReferenceR3) extends DomainResource <<type+>> {
  src.masterIdentifier as vs -> tgt.masterIdentifier as vt then string(vs, vt);
  src.identifier as vs -> tgt.identifier as vt then Identifier(vs, vt);
  src.status as vs -> tgt.status as vt then code(vs, vt);
  src.docStatus as vs -> tgt.docStatus as vt then string(vs, vt);
  src.type as vs -> tgt.type as vt then string(vs, vt);
  src.category -> tgt.class;
  src.subject as vs -> tgt.subject as vt then Reference(vs, vt);
  src.date -> tgt.indexed;
  src.extension as ext where url = 'http://hl7.org/fhir/3.0/StructureDefinition/extension-DocumentReference.created' then {
    ext.value as vs0 -> tgt.created = vs0 "created2";
  } "created";
  src.agent as s where type.coding.where((system = 'http://terminology.hl7.org/CodeSystem/v3-ParticipationType') and (code = 'AUT')).exists() -> tgt.author as t then agent(s, t);
  src.authenticator as vs -> tgt.authenticator as vt then string(vs, vt);
  src.custodian as vs -> tgt.custodian as vt then string(vs, vt);
  src.relatesTo as vs0 -> tgt.relatesTo as vt0 then relatesTo(vs0, vt0);
  src.description as vs -> tgt.description as vt then markdown(vs, vt);
  src.securityLabel as vs -> tgt.securityLabel as vt then string(vs, vt);
  src.content as vs0 -> tgt.content as vt0 then content(vs0, vt0);
  src.context as vs0 -> tgt.context as vt0 then context(vs0, vt0);
}

group agent(source src, target tgt) extends Element {
  src.who as vs0 then Reference(vs0, tgt);
}

group relatesTo(source src, target tgt) extends BackboneElement {
  src.code as vs -> tgt.code as vt then CodeableConcept(vs, vt);
  src.target as vs -> tgt.target as vt then string(vs, vt);
}

group content(source src, target tgt) extends BackboneElement {
  src.attachment as vs -> tgt.attachment as vt then string(vs, vt);
  src.format as vs -> tgt.format as vt then string(vs, vt);
}

group context(source src, target tgt) extends BackboneElement {
  src.encounter as vs -> tgt.encounter as vt then Reference(vs, vt);
  src.event as vs -> tgt.event as vt then string(vs, vt);
  src.period as vs -> tgt.period as vt then string(vs, vt);
  src.facilityType as vs -> tgt.facilityType as vt then string(vs, vt);
  src.practiceSetting as vs -> tgt.practiceSetting as vt then string(vs, vt);
  src.sourcePatientInfo as vs -> tgt.sourcePatientInfo as vt then string(vs, vt);
  src.related as vs0 -> tgt.related as vt0 then related(vs0, vt0);
}

group related(source src, target tgt) {
  src where reference.exists() -> tgt.ref as vt0 then ReferenceNoIdentifier(src, vt0) "reference";
  src where identifier.exists() -> tgt.identifier as vt0 then Reference2Identifier(src, vt0) "identifier";
}

